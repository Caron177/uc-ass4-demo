<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Urban Sensing Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: #f5f5f5;
      padding: 16px;
    }
    .card {
      max-width: 480px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      padding: 16px 20px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.06);
    }
    h1 {
      font-size: 20px;
      margin-bottom: 8px;
      text-align: center;
    }
    .small {
      font-size: 12px;
      color: #666;
      text-align: center;
      margin-bottom: 16px;
    }
    .row {
      margin: 8px 0;
      font-size: 14px;
    }
    .label {
      font-weight: bold;
    }
    .value {
      margin-left: 4px;
    }
    .recommend {
      margin-top: 12px;
      padding: 10px;
      border-radius: 8px;
      background: #f0f7ff;
      font-size: 14px;
      line-height: 1.4;
    }
    .buttons {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-top: 16px;
    }
    button {
      padding: 8px 16px;
      border-radius: 20px;
      border: none;
      font-size: 14px;
      cursor: pointer;
    }
    .start-btn {
      background: #2e7d32;
      color: white;
    }
    .stop-btn {
      background: #b71c1c;
      color: white;
    }
    .status {
      margin-top: 8px;
      font-size: 12px;
      color: #999;
      text-align: center;
    }
    .error {
      color: #c62828;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>Urban Sensing Demo</h1>
    <div class="small">Real-time acceleration + weather analysis + outdoor index</div>

    <div class="row">
      <span class="label">Acceleration magnitude:</span>
      <span class="value" id="acc-mag">--</span>
    </div>
    <div class="row">
      <span class="label">Activity:</span>
      <span class="value" id="activity">--</span>
    </div>
    <div class="row">
      <span class="label">Weather:</span>
      <span class="value" id="weather">--</span>
    </div>
    <div class="row">
      <span class="label">Temperature:</span>
      <span class="value" id="temp">--</span>
    </div>

    <!-- EXTRA TASK: Outdoor Suitability Index UI -->
    <div class="row">
      <span class="label">Outdoor index:</span>
      <span class="value" id="outdoor-index">--</span>
    </div>
    <div class="row" id="outdoor-status" style="font-size:12px; color:#666;">
      --
    </div>

    <div class="recommend" id="recommend">
      Recommendations will appear here.
    </div>

    <div class="buttons">
      <button class="start-btn" id="start-btn">Start</button>
      <button class="stop-btn" id="stop-btn">Stop</button>
    </div>

    <div class="status" id="status">
      Click "Start" and allow motion sensor access.
    </div>
  </div>

  <script>
    // ======= CONFIGURATION =======
    const THINGSPEAK_WRITE_KEY = "YPU2K0E56HO6P5N2";
    const CHANNEL_ID = 3172051;
    const OPENWEATHER_KEY = "94eb588080afeb13f7fcae2136db4b45";
    const CITY = "Dublin,IE";
    const SEND_INTERVAL_MS = 20000;

    // ======= PAGE ELEMENTS =======
    const accMagEl = document.getElementById("acc-mag");
    const activityEl = document.getElementById("activity");
    const weatherEl = document.getElementById("weather");
    const tempEl = document.getElementById("temp");
    const recommendEl = document.getElementById("recommend");
    const statusEl = document.getElementById("status");
    const startBtn = document.getElementById("start-btn");
    const stopBtn = document.getElementById("stop-btn");
    const outdoorIndexEl = document.getElementById("outdoor-index");
    const outdoorStatusEl = document.getElementById("outdoor-status");

    let collecting = false;
    let lastSendTime = 0;
    let latestWeather = null;

    // ======= ACTIVITY CLASSIFICATION =======
    function classifyActivity(mag) {
      if (mag < 2) {
        return "Stationary ðŸ§";
      } else if (mag < 6) {
        return "Walking ðŸš¶";
      } else {
        return "Running ðŸƒ";
      }
    }

    // ======= EXTRA TASK: OUTDOOR INDEX ALGORITHM =======
    function computeOutdoorIndex(activity, temp, weatherMain) {
      if (temp == null || weatherMain == null) return null;

      let score = 50; // base score

      // Activity factor
      if (activity.includes("Running")) score += 20;
      else if (activity.includes("Walking")) score += 10;

      // Weather factor
      const bad = ["Rain", "Snow", "Thunderstorm"];
      const ok = ["Clouds", "Drizzle"];
      if (bad.includes(weatherMain)) score -= 30;
      else if (ok.includes(weatherMain)) score -= 10;

      // Temperature factor
      if (temp < 0 || temp > 30) {
        score -= 30;
      } else if ((temp >= 0 && temp < 5) || (temp > 25 && temp <= 30)) {
        score -= 10;
      }

      // Clamp 0â€“100
      score = Math.max(0, Math.min(100, score));
      return score;
    }

    function describeOutdoorIndex(score) {
      if (score == null) return "Not enough data to evaluate conditions.";
      if (score >= 70) return "Good conditions for outdoor activity.";
      if (score >= 40) return "Acceptable, but be cautious.";
      return "Poor conditions. Limit outdoor activity if possible.";
    }

    // ======= RECOMMENDATION LOGIC =======
    function makeRecommendation(activity, temp, weatherMain) {
      if (temp == null || weatherMain == null) {
        return "Collecting data...";
      }

      const isBadWeather = ["Rain", "Snow", "Thunderstorm"].includes(weatherMain);
      const tooCold = temp < 0;
      const tooHot = temp > 30;

      if (activity.includes("Running")) {
        if (isBadWeather) {
          return `You are running, but the current weather (${weatherMain}) is not ideal. Indoor exercise is recommended.`;
        } else if (tooCold || tooHot) {
          return `You are running. Temperature is ${temp.toFixed(1)}Â°C. Not ideal for high-intensity outdoor activity.`;
        } else {
          return "You are running. Weather and temperature are suitable for outdoor exercise.";
        }
      } else if (activity.includes("Walking")) {
        if (isBadWeather) {
          return `You are walking, but the weather (${weatherMain}) is not great. Try to reduce outdoor exposure if possible.`;
        } else {
          return "You are walking. Weather is acceptable for normal activity.";
        }
      } else {
        if (isBadWeather && tooCold) {
          return "You are stationary. Weather is cold and unpleasant; staying indoors is a good choice.";
        } else {
          return "You are stationary. If you want more exercise, consider walking a bit depending on the weather.";
        }
      }
    }

    // ======= FETCH WEATHER =======
    async function fetchWeather() {
      try {
        const url = `https://api.openweathermap.org/data/2.5/weather?q=${CITY}&appid=${OPENWEATHER_KEY}&units=metric`;
        const res = await fetch(url);
        const data = await res.json();
        const temp = data.main.temp;
        const main = data.weather[0].main;
        latestWeather = { temp, main };
        weatherEl.textContent = main;
        tempEl.textContent = temp.toFixed(1) + " Â°C";
      } catch (e) {
        console.error(e);
        statusEl.textContent = "Failed to fetch weather.";
        statusEl.classList.add("error");
      }
    }

    // ======= SEND DATA TO THINGSPEAK (INCLUDING OUTDOOR INDEX) =======
    async function sendToThingspeak(ax, ay, az, temp, weatherMain, index) {
      try {
        const params = new URLSearchParams({
          api_key: THINGSPEAK_WRITE_KEY,
          field1: ax.toFixed(3),
          field2: ay.toFixed(3),
          field3: az.toFixed(3),
          field4: temp != null ? temp.toFixed(2) : "",
          field5: weatherMain || "",
          field6: index != null ? index.toFixed(0) : ""
        });
        const url = "https://api.thingspeak.com/update?" + params.toString();
        const res = await fetch(url);
        const text = await res.text();
        console.log("ThingSpeak response:", text);
      } catch (e) {
        console.error("Failed to send to ThingSpeak:", e);
      }
    }

    // ======= HANDLE MOTION EVENT =======
    function handleMotion(event) {
      if (!collecting) return;

      const ax = event.accelerationIncludingGravity.x || 0;
      const ay = event.accelerationIncludingGravity.y || 0;
      const az = event.accelerationIncludingGravity.z || 0;

      const mag = Math.sqrt(ax*ax + ay*ay + az*az);

      accMagEl.textContent = mag.toFixed(2);
      const activity = classifyActivity(mag);
      activityEl.textContent = activity;

      const temp = latestWeather ? latestWeather.temp : null;
      const weatherMain = latestWeather ? latestWeather.main : null;

      // Extra task: compute and display outdoor index
      const index = computeOutdoorIndex(activity, temp, weatherMain);
      if (index == null) {
        outdoorIndexEl.textContent = "--";
        outdoorStatusEl.textContent = "Waiting for data...";
        outdoorStatusEl.style.color = "#666";
      } else {
        outdoorIndexEl.textContent = index.toFixed(0) + " / 100";
        outdoorStatusEl.textContent = describeOutdoorIndex(index);
        if (index < 40) {
          outdoorStatusEl.style.color = "#b71c1c"; // warning
        } else {
          outdoorStatusEl.style.color = "#666";
        }
      }

      recommendEl.textContent = makeRecommendation(activity, temp, weatherMain);

      const now = Date.now();
      if (now - lastSendTime > SEND_INTERVAL_MS) {
        lastSendTime = now;
        if (!latestWeather) {
          fetchWeather().then(() => {
            const t = latestWeather ? latestWeather.temp : null;
            const w = latestWeather ? latestWeather.main : null;
            const idx = computeOutdoorIndex(activity, t, w);
            sendToThingspeak(ax, ay, az, t, w, idx);
          });
        } else {
          sendToThingspeak(ax, ay, az, temp, weatherMain, index);
        }
      }
    }

    // ======= START & STOP COLLECTION =======
    async function startCollect() {
      if (collecting) return;

      // iOS permission request
      if (typeof DeviceMotionEvent !== "undefined" &&
          typeof DeviceMotionEvent.requestPermission === "function") {
        try {
          const response = await DeviceMotionEvent.requestPermission();
          if (response !== "granted") {
            statusEl.textContent = "Motion sensor permission denied.";
            statusEl.classList.add("error");
            return;
          }
        } catch (e) {
          statusEl.textContent = "Error requesting motion permission.";
          statusEl.classList.add("error");
          return;
        }
      }

      window.addEventListener("devicemotion", handleMotion);
      collecting = true;
      statusEl.textContent = "Collecting data... Move your phone gently.";
      statusEl.classList.remove("error");

      fetchWeather();
    }

    function stopCollect() {
      collecting = false;
      window.removeEventListener("devicemotion", handleMotion);
      statusEl.textContent = "Collection stopped.";
    }

    startBtn.addEventListener("click", startCollect);
    stopBtn.addEventListener("click", stopCollect);
  </script>
</body>
</html>
