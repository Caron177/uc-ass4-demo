<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>Urban Sensing Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: #f5f5f5;
      padding: 16px;
    }
    .card {
      max-width: 480px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      padding: 16px 20px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.06);
    }
    h1 {
      font-size: 20px;
      margin-bottom: 8px;
      text-align: center;
    }
    .small {
      font-size: 12px;
      color: #666;
      text-align: center;
      margin-bottom: 16px;
    }
    .row {
      margin: 8px 0;
      font-size: 14px;
    }
    .label {
      font-weight: bold;
    }
    .value {
      margin-left: 4px;
    }
    .recommend {
      margin-top: 12px;
      padding: 10px;
      border-radius: 8px;
      background: #f0f7ff;
      font-size: 14px;
      line-height: 1.4;
    }
    .buttons {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-top: 16px;
    }
    button {
      padding: 8px 16px;
      border-radius: 20px;
      border: none;
      font-size: 14px;
      cursor: pointer;
    }
    .start-btn {
      background: #2e7d32;
      color: white;
    }
    .stop-btn {
      background: #b71c1c;
      color: white;
    }
    .status {
      margin-top: 8px;
      font-size: 12px;
      color: #999;
      text-align: center;
    }
    .error {
      color: #c62828;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>Urban Sensing Demo</h1>
    <div class="small">äººä½“åŠ é€Ÿåº¦ + å¤©æ°” å®æ—¶åˆ†æ</div>

    <div class="row">
      <span class="label">å½“å‰åŠ é€Ÿåº¦å¤§å°ï¼š</span>
      <span class="value" id="acc-mag">--</span>
    </div>
    <div class="row">
      <span class="label">åˆ¤æ–­æ´»åŠ¨ï¼š</span>
      <span class="value" id="activity">--</span>
    </div>
    <div class="row">
      <span class="label">å½“å‰å¤©æ°”ï¼š</span>
      <span class="value" id="weather">--</span>
    </div>
    <div class="row">
      <span class="label">å½“å‰æ¸©åº¦ï¼š</span>
      <span class="value" id="temp">--</span>
    </div>

    <div class="recommend" id="recommend">
      ç³»ç»Ÿå»ºè®®ä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œã€‚
    </div>

    <div class="buttons">
      <button class="start-btn" id="start-btn">å¼€å§‹é‡‡é›†</button>
      <button class="stop-btn" id="stop-btn">åœæ­¢é‡‡é›†</button>
    </div>

    <div class="status" id="status">
      è¯·ç‚¹å‡»â€œå¼€å§‹é‡‡é›†â€å¹¶å…è®¸è®¿é—®è¿åŠ¨ä¼ æ„Ÿå™¨ã€‚
    </div>
  </div>

  <script>
    // ======= è¿™é‡Œæ˜¯ä½ è‡ªå·±çš„é…ç½® =======
    const THINGSPEAK_WRITE_KEY = "YPU2K0E56HO6P5N2";   // ä½ çš„ Write API Key
    const CHANNEL_ID = 3172051;                        // ä½ çš„ Channel ID
    const OPENWEATHER_KEY = "94eb588080afeb13f7fcae2136db4b45";  // ä½ çš„å¤©æ°” key
    const CITY = "Dublin,IE"; // ä½ å¯ä»¥æ¢æˆä½ æ‰€åœ¨åŸå¸‚ï¼Œæ¯”å¦‚ "Beijing"
    const SEND_INTERVAL_MS = 20000; // æ¯ 20 ç§’å‘ Thingspeak å‘é€ä¸€æ¬¡

    // ======= é¡µé¢å…ƒç´  =======
    const accMagEl = document.getElementById("acc-mag");
    const activityEl = document.getElementById("activity");
    const weatherEl = document.getElementById("weather");
    const tempEl = document.getElementById("temp");
    const recommendEl = document.getElementById("recommend");
    const statusEl = document.getElementById("status");
    const startBtn = document.getElementById("start-btn");
    const stopBtn = document.getElementById("stop-btn");

    let collecting = false;
    let lastSendTime = 0;
    let latestWeather = null; // {temp, main}

    // ======= ç®—æ³•éƒ¨åˆ†ï¼šæ´»åŠ¨åˆ†ç±» =======
    function classifyActivity(mag) {
      if (mag < 2) {
        return "é™æ­¢ ğŸ§";
      } else if (mag < 6) {
        return "èµ°è·¯ ğŸš¶";
      } else {
        return "è·‘æ­¥ ğŸƒ";
      }
    }

    // ======= ç®—æ³•éƒ¨åˆ†ï¼šç»™å‡ºå»ºè®® =======
    function makeRecommendation(activity, temp, weatherMain) {
      if (temp == null || weatherMain == null) {
        return "æ­£åœ¨é‡‡é›†æ•°æ®...";
      }

      const isBadWeather = ["Rain", "Snow", "Thunderstorm"].includes(weatherMain);
      const tooCold = temp < 0;
      const tooHot = temp > 30;

      if (activity.includes("è·‘æ­¥")) {
        if (isBadWeather) {
          return "æ­£åœ¨è·‘æ­¥ï¼Œä½†å½“å‰å¤©æ°”ä¸ä½³ï¼ˆ" + weatherMain + "ï¼‰ï¼Œä¸å»ºè®®æˆ·å¤–è·‘æ­¥ï¼Œå¯ä»¥æ”¹ä¸ºå®¤å†…è¿åŠ¨ã€‚";
        } else if (tooCold || tooHot) {
          return "æ­£åœ¨è·‘æ­¥ï¼Œæ°”æ¸© " + temp.toFixed(1) + "â„ƒï¼Œä¸å¤ªé€‚åˆé•¿æ—¶é—´é«˜å¼ºåº¦æˆ·å¤–è¿åŠ¨ï¼Œè¯·æ³¨æ„èº«ä½“ã€‚";
        } else {
          return "æ­£åœ¨è·‘æ­¥ï¼Œå¤©æ°”å’Œæ¸©åº¦éƒ½è¿˜ä¸é”™ï¼Œé€‚åˆé€‚åº¦æˆ·å¤–è¿åŠ¨ã€‚";
        }
      } else if (activity.includes("èµ°è·¯")) {
        if (isBadWeather) {
          return "æ­£åœ¨èµ°è·¯ï¼Œå¤–é¢å¤©æ°”ï¼ˆ" + weatherMain + "ï¼‰ï¼Œå¦‚æœä¸æ˜¯å¿…é¡»å¤–å‡ºï¼Œå»ºè®®ç¼©çŸ­åœ¨æˆ·å¤–åœç•™æ—¶é—´ã€‚";
        } else {
          return "æ­£åœ¨èµ°è·¯ï¼Œå¤©æ°”åŸºæœ¬å¯ä»¥ï¼Œé€‚åˆä½œä¸ºæ—¥å¸¸æ´»åŠ¨ã€‚";
        }
      } else {
        if (isBadWeather && tooCold) {
          return "å½“å‰åŸºæœ¬é™æ­¢ï¼Œå¤–é¢åˆå†·åˆå¤©æ°”ä¸å¥½ï¼Œå…¶å®å¾…åœ¨å®¤å†…æ˜¯ä¸é”™çš„é€‰æ‹©ã€‚";
        } else {
          return "å½“å‰æ¯”è¾ƒé™æ­¢ï¼Œå¦‚æœæƒ³å¢åŠ è¿åŠ¨é‡ï¼Œå¯ä»¥é€‚åº¦èµ°åŠ¨ä¸€ä¸‹ï¼ˆæ³¨æ„æ ¹æ®å¤©æ°”å’Œæ¸©åº¦å®‰æ’ï¼‰ã€‚";
        }
      }
    }

    // ======= è·å–å¤©æ°” =======
    async function fetchWeather() {
      try {
        const url = `https://api.openweathermap.org/data/2.5/weather?q=${CITY}&appid=${OPENWEATHER_KEY}&units=metric`;
        const res = await fetch(url);
        const data = await res.json();
        const temp = data.main.temp;
        const main = data.weather[0].main;
        latestWeather = { temp, main };
        weatherEl.textContent = main;
        tempEl.textContent = temp.toFixed(1) + " â„ƒ";
      } catch (e) {
        console.error(e);
        statusEl.textContent = "è·å–å¤©æ°”å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œã€‚";
        statusEl.classList.add("error");
      }
    }

    // ======= å‘é€æ•°æ®åˆ° Thingspeak =======
    async function sendToThingspeak(ax, ay, az, temp, weatherMain) {
      try {
        const params = new URLSearchParams({
          api_key: THINGSPEAK_WRITE_KEY,
          field1: ax.toFixed(3),
          field2: ay.toFixed(3),
          field3: az.toFixed(3),
          field4: temp != null ? temp.toFixed(2) : "",
          field5: weatherMain || ""
        });
        const url = "https://api.thingspeak.com/update?" + params.toString();
        const res = await fetch(url);
        const text = await res.text();
        console.log("ThingSpeak response:", text);
      } catch (e) {
        console.error("å‘é€åˆ° ThingSpeak å¤±è´¥:", e);
      }
    }

    // ======= å¤„ç†åŠ é€Ÿåº¦äº‹ä»¶ =======
    function handleMotion(event) {
      if (!collecting) return;

      const ax = event.accelerationIncludingGravity.x || 0;
      const ay = event.accelerationIncludingGravity.y || 0;
      const az = event.accelerationIncludingGravity.z || 0;

      const mag = Math.sqrt(ax*ax + ay*ay + az*az);

      accMagEl.textContent = mag.toFixed(2);
      const activity = classifyActivity(mag);
      activityEl.textContent = activity;

      const temp = latestWeather ? latestWeather.temp : null;
      const weatherMain = latestWeather ? latestWeather.main : null;
      const rec = makeRecommendation(activity, temp, weatherMain);
      recommendEl.textContent = rec;

      const now = Date.now();
      if (now - lastSendTime > SEND_INTERVAL_MS) {
        lastSendTime = now;
        if (!latestWeather) {
          fetchWeather().then(() => {
            const t = latestWeather ? latestWeather.temp : null;
            const w = latestWeather ? latestWeather.main : null;
            sendToThingspeak(ax, ay, az, t, w);
          });
        } else {
          sendToThingspeak(ax, ay, az, temp, weatherMain);
        }
      }
    }

    // ======= å¼€å§‹å’Œåœæ­¢æŒ‰é’®é€»è¾‘ =======
    async function startCollect() {
      if (collecting) return;

      if (typeof DeviceMotionEvent !== "undefined" &&
          typeof DeviceMotionEvent.requestPermission === "function") {
        try {
          const response = await DeviceMotionEvent.requestPermission();
          if (response !== "granted") {
            statusEl.textContent = "ä½ æ‹’ç»äº†è¿åŠ¨ä¼ æ„Ÿå™¨æƒé™ï¼Œæ— æ³•é‡‡é›†æ•°æ®ã€‚";
            statusEl.classList.add("error");
            return;
          }
        } catch (e) {
          statusEl.textContent = "è¯·æ±‚ä¼ æ„Ÿå™¨æƒé™æ—¶å‡ºé”™ã€‚";
          statusEl.classList.add("error");
          return;
        }
      }

      window.addEventListener("devicemotion", handleMotion);
      collecting = true;
      statusEl.textContent = "æ­£åœ¨é‡‡é›†æ•°æ®ï¼Œè¯·è½»è½»èµ°åŠ¨æˆ–æ™ƒåŠ¨æ‰‹æœºã€‚";
      statusEl.classList.remove("error");

      fetchWeather();
    }

    function stopCollect() {
      collecting = false;
      window.removeEventListener("devicemotion", handleMotion);
      statusEl.textContent = "å·²åœæ­¢é‡‡é›†ã€‚";
    }

    startBtn.addEventListener("click", startCollect);
    stopBtn.addEventListener("click", stopCollect);
  </script>
</body>
</html>
